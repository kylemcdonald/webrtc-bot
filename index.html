<!DOCTYPE html>
<html>

<head>
  <title>WebSocket Video Stream</title>
  <link rel="icon" href="data:,">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: black;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    #videoContainer {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 80vh;
    }

    #localVideo,
    #remoteVideo {
      height: 100%;
      width: 50%;
      object-fit: contain;
    }

    #controls {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #videoDevices {
      margin-bottom: 20px;
      padding: 10px;
      font-size: 18px;
      background-color: #333;
      color: white;
      border: 2px solid white;
      border-radius: 5px;
    }

    #startButton {
      padding: 15px 30px;
      font-size: 24px;
      background-color: black;
      color: white;
      border: 2px solid white;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      touch-action: manipulation;
    }

    #startButton:hover {
      background-color: #333;
    }

    #startButton:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #debugInfo {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      z-index: 1000;
    }
  </style>
</head>

<body>
  <div id="controls">
    <select id="videoDevices"></select>
    <button id="startButton" onclick="start()">Start</button>
  </div>
  <div id="videoContainer">
    <video id="localVideo" autoplay muted></video>
    <canvas id="remoteVideo"></canvas>
  </div>
  <div id="debugInfo"></div>

  <script>
    const quality = 0.5;

    let ws;
    let localStream;
    let videoTrack;
    let canvas;
    let ctx;
    let startTime;
    let sendFrameCount = 0;
    let receiveFrameCount = 0;
    let bytesSent = 0;
    let bytesReceived = 0;
    let lastUpdateTime;
    let lastBytesSent = 0;
    let lastBytesReceived = 0;
    let videoFrameCallbackId;

    async function enumerateDevices() {
      const deviceSelect = document.getElementById('videoDevices');
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(device => device.kind === 'videoinput');

      videoDevices.forEach(device => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.text = device.label || `Camera ${deviceSelect.length + 1}`;
        deviceSelect.appendChild(option);
      });
    }

    async function start() {
      const startButton = document.getElementById('startButton');
      const deviceSelect = document.getElementById('videoDevices');

      startButton.textContent = 'Connecting...';
      startButton.disabled = true;

      const selectedDeviceId = deviceSelect.value;

      localStream = await navigator.mediaDevices.getUserMedia({
        video: {
          deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined,
          width: 1080,
          height: 1080,
          frameRate: 30
        },
        audio: false
      });

      const localVideo = document.getElementById('localVideo');
      localVideo.srcObject = localStream;

      videoTrack = localStream.getVideoTracks()[0];
      const settings = videoTrack.getSettings();

      canvas = document.createElement('canvas');
      canvas.width = settings.width;
      canvas.height = settings.height;
      ctx = canvas.getContext('2d');

      const remoteCanvas = document.getElementById('remoteVideo');
      remoteCanvas.width = settings.width;
      remoteCanvas.height = settings.height;
      const remoteCtx = remoteCanvas.getContext('2d');

      const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws`);

      ws.onopen = () => {
        document.getElementById('controls').style.display = 'none';
        startTime = Date.now();
        requestVideoFrame();
      };

      ws.onmessage = (event) => {
        const img = new Image();
        img.onload = () => {
          remoteCtx.drawImage(img, 0, 0);
          bytesReceived += event.data.size;
          lastBytesReceived = event.data.size;
          receiveFrameCount++;
          URL.revokeObjectURL(img.src);
        };
        img.src = URL.createObjectURL(new Blob([event.data], { type: 'image/jpeg' }));
      };
    }

    function requestVideoFrame() {
      videoFrameCallbackId = localVideo.requestVideoFrameCallback(processVideoFrame);
    }

    function processVideoFrame(now, metadata) {
      ctx.drawImage(localVideo, 0, 0, canvas.width, canvas.height);
      canvas.toBlob((blob) => {
        ws.send(blob);
        bytesSent += blob.size;
        lastBytesSent = blob.size;
        sendFrameCount++;
        updateDebugInfo();

        requestVideoFrame(); // Request the next frame
      }, 'image/jpeg', quality);
    }

    function updateDebugInfo() {
      const now = Date.now();
      if (now - lastUpdateTime < 1000) return;

      const elapsedTime = (now - startTime) / 1000;
      const sendFps = (sendFrameCount / elapsedTime).toFixed(2);
      const receiveFps = (receiveFrameCount / elapsedTime).toFixed(2);
      const sendBandwidthKbps = ((bytesSent / 1024) / elapsedTime).toFixed();
      const receiveBandwidthKbps = ((bytesReceived / 1024) / elapsedTime).toFixed();
      const lastBytesReceivedKb = (lastBytesReceived / 1024).toFixed();
      const lastBytesSentKb = (lastBytesSent / 1024).toFixed();

      const debugInfo = `
        Send FPS: ${sendFps}
        Receive FPS: ${receiveFps}
        Send Bandwidth: ${sendBandwidthKbps} Kbps
        Receive Bandwidth: ${receiveBandwidthKbps} Kbps
        Last Sent: ${lastBytesSentKb} Kb
        Last Received: ${lastBytesReceivedKb} Kb
        Total Sent: ${(bytesSent / (1024 * 1024)).toFixed(2)} MB
        Total Received: ${(bytesReceived / (1024 * 1024)).toFixed(2)} MB
      `;

      document.getElementById('debugInfo').innerText = debugInfo;
      lastUpdateTime = now;
    }

    function cleanup() {
      if (ws) {
        ws.close();
      }
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
      }
      if (videoFrameCallbackId) {
        localVideo.cancelVideoFrameCallback(videoFrameCallbackId);
      }
    }

    window.addEventListener('beforeunload', cleanup);

    enumerateDevices();
  </script>
</body>

</html>
